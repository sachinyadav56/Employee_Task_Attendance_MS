<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Employee Dashboard | ETAMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f4f7fa;
            --slate-900: #0f172a;
            --indigo-600: #4f46e5;
            --rose-600: #e11d48;
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        body { background-color: var(--bg-body); font-family: 'Inter', system-ui, sans-serif; color: var(--slate-900); }
        .navbar { background: var(--slate-900); padding: 1rem 1.5rem; }
        .card { border: none; border-radius: 12px; box-shadow: var(--shadow-md); background: #ffffff; overflow: hidden; height: 100%; }
        .field-card { padding: 1.5rem; display: flex; flex-direction: column; }
        .accent-login { border-top: 5px solid #64748b; }
        .accent-break { border-top: 5px solid var(--rose-600); }
        .accent-work { border-top: 5px solid var(--indigo-600); }
        .field-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; margin-bottom: 0.75rem; }
        .field-value { font-size: 1.7rem; font-weight: 700; white-space: nowrap; }
        .timer-font { font-family: 'Courier New', monospace; }
        .text-break { color: var(--rose-600); }
        .text-work { color: var(--indigo-600); }
        #logoutBtn { background: rgba(225, 29, 72, 0.1); color: var(--rose-600); border: 1px solid var(--rose-600); }
        #logoutBtn:hover { background: var(--rose-600); color: white; }
    </style>
</head>

<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand fw-bold">
            <i class="bi bi-cpu-fill text-info me-2"></i> ETAMS
        </span>
        <div class="d-flex gap-2">
            <a href="{% url 'attendance_report' %}" class="btn btn-sm btn-outline-light px-3">
                <i class="bi bi-calendar-check me-1"></i> Attendance
            </a>
            <a href="{% url 'assigned_tasks' %}" class="btn btn-sm btn-outline-light px-3">
                <i class="bi bi-list-task me-1"></i> Tasks
            </a>
            <button id="logoutBtn" class="btn btn-sm px-3">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container">

    <div class="card p-4 mb-4 border-start border-info border-5">
        <h4 class="fw-bold mb-1">Employee ID: {{ employee.employee_id }}</h4>
        <h4 class="fw-bold mb-1">Department: {{ employee.department.name }}</h4>
        <h4 class="fw-bold mb-1">Role: {{ employee.role }}</h4>
    </div>

    <div class="row g-4">

        <div class="col-md-3">
            <div class="card field-card accent-login">
                <span class="field-label">Login Time</span>
                <div class="field-value">
                    {{ attendance.login_time|time:"h:i A"|default:"--" }}
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card field-card">
                <span class="field-label">Late Time</span>
                <div class="field-value text-danger">
                    {% if late_display %}{{ late_display }}{% else %}00 min{% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card field-card accent-break">
                <span class="field-label text-danger">Total Break</span>
                <div class="field-value timer-font text-break" id="breakTimer">00:00:00</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card field-card accent-work">
                <span class="field-label text-primary">Live Work Time</span>
                <div class="field-value timer-font text-work" id="workTimer">00:00:00</div>
            </div>
        </div>

    </div>
</div>

<script>
    const workTimer = document.getElementById("workTimer");
    const breakTimer = document.getElementById("breakTimer");

    let workSeconds = {{ working_seconds|default:0 }};
    let breakSeconds = {{ break_seconds|default:0 }};

    function formatTime(sec) {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    workTimer.innerText = formatTime(workSeconds);
    breakTimer.innerText = formatTime(breakSeconds);
    
    // Live work timer only
    setInterval(() => {
        workSeconds++;
        workTimer.innerText = formatTime(workSeconds);
    }, 1000);

    document.getElementById("logoutBtn").onclick = () => {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "{% url 'employee_logout' %}";

        const csrf = document.createElement("input");
        csrf.type = "hidden";
        csrf.name = "csrfmiddlewaretoken";
        csrf.value = "{{ csrf_token }}";
        form.appendChild(csrf);

        ["work_seconds", "break_seconds"].forEach(key => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = key === "work_seconds" ? workSeconds : breakSeconds;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    };
</script>

</body>
</html>